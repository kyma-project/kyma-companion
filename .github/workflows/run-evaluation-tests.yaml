name: "Evaluation tests"
run-name: "Evaluation tests"

on:
  workflow_dispatch:
    inputs:
      IMAGE_NAME:
        description: "Docker image to use for tests"
        required: true
      K3S_IMAGE:
        description: "Optional: k3s image to pin (e.g., rancher/k3s:v1.28.5-k3s1). Leave empty for k3d default."
        required: false
        default: ""

env:
  DOCKER_TIMEOUT: 30
  K3D_VERSION: "v5.7.2"

jobs:
  wait-for-build:
    name: Wait for image build job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install requirements
        run: |
          pip install -r ./scripts/python/wait-for-commit-check/requirements.txt

      - name: wait for build
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GIT_REF: ${{ github.sha }}
          REPOSITORY_FULL_NAME: "${{ github.repository }}"
          GIT_CHECK_RUN_NAME: "build / Build image"
          INTERVAL: 60
          TIMEOUT: 900
        run: |
          python ./scripts/python/wait-for-commit-check/run.py

  evaluation:
    uses: kyma-project/kyma-companion/.github/workflows/evaluation-test-reusable.yaml@main
    needs: wait-for-build
    secrets: inherit
    with:
      IMAGE_NAME: ${{ inputs.IMAGE_NAME }}
      TEST_REPO_FULLNAME: ${{ github.repository }}
      TEST_REF: main
      K3S_IMAGE: ${{ inputs.K3S_IMAGE }}
